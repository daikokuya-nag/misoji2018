<?php/********************週間出勤予定 Version 1.0PHP52016 Mar. 1 ver 1.0********************/	require_once dirname(__FILE__) . '/../db/dbWorks5C.php';	require_once dirname(__FILE__) . '/../db/dbProfile5C.php';	require_once dirname(__FILE__) . '/../dateTime5C.php';	$branchNo = $_REQUEST['branchNo'];	$profDir  = $_REQUEST['profDir'];	$daysList = setDaysList();											/***** 対象日付の取得 *****/	$workVals = setWorkTimes($branchNo ,$profDir ,$daysList);	/***** 日毎の出勤状態の取り出し *****/	$ret = setList($workVals ,$daysList['dowCLASS'] ,$daysList['daySTRD'] ,$daysList['dowSTR']);	print json_encode($ret);	/********************	対象日付の取得	パラメータ：-	戻り値　　：日付データ	********************/	function setDaysList() {		/***** 曜日表示のclass名 *****/		$dowClass = array('daySun' ,'' ,'' ,'' ,'' ,'' ,'daySat');		$format = 'Y' . dateTime5C::DATE_SEP . 'm' . dateTime5C::DATE_SEP . 'd' . ' ' . 'H' . dateTime5C::TIME_SEP . 'i' . dateTime5C::TIME_SEP . 's';		$now = time();		for($dayIdx=0 ;$dayIdx<=6 ;$dayIdx++) {			$paramStr = '+' . $dayIdx . ' day';			$timeStr  = strtotime($paramStr ,$now);			$dtStr    = date($format, $timeStr);			$dt = dateTime5C::divideDTStr($dtStr);			/***** 該当日付のリスト *****/			$dowCD  = dateTime5C::getDOW($dtStr);		/* 曜日コード */			$dowStr = dateTime5C::getDOWStr($dowCD);	/* 曜日文字 */			$dt0[dateTime5C::MONTH] = sprintf('%02d' ,$dt[dateTime5C::MONTH]);			$dt0[dateTime5C::DAY]   = sprintf('%02d' ,$dt[dateTime5C::DAY]);			$daySTRCList[$dayIdx ] = $dt[dateTime5C::YEAR] . '-' . $dt0[dateTime5C::MONTH] . '-' . $dt0[dateTime5C::DAY];	/* 該当日の比較 */			$daySTRDList[$dayIdx ] = $dt[dateTime5C::MONTH] . '/' . $dt[dateTime5C::DAY];		/* 該当日の表示 */			$dowCDList[$dayIdx   ] = $dowCD;				/* 曜日コード */			$dowSTRList[$dayIdx  ] = $dowStr;				/* 曜日文字 */			$dowCLASSList[$dayIdx] = $dowClass[$dowCD];		}		$ret['daySTRC' ] = $daySTRCList;		$ret['daySTRD' ] = $daySTRDList;		$ret['dowCD'   ] = $dowCDList;		$ret['dowSTR'  ] = $dowSTRList;		$ret['dowCLASS'] = $dowCLASSList;		return $ret;	}	/********************	日毎の出勤状態の取得	パラメータ：グループNo	　　　　　　店No	　　　　　　対象日付	戻り値　　：日付データ	********************/	function setWorkTimes($branchNo ,$profDir ,$daysList) {		/***** 曜日毎の時刻のフィールド *****/		$dowIdxList = array(			0 => array(dbWorks5C::IDX_F => dbWorks5C::FLD_SUN_F ,dbWorks5C::IDX_T => dbWorks5C::FLD_SUN_T ,dbWorks5C::IDX_M => dbWorks5C::FLD_SUN_M) ,			1 => array(dbWorks5C::IDX_F => dbWorks5C::FLD_MON_F ,dbWorks5C::IDX_T => dbWorks5C::FLD_MON_T ,dbWorks5C::IDX_M => dbWorks5C::FLD_MON_M) ,			2 => array(dbWorks5C::IDX_F => dbWorks5C::FLD_TUE_F ,dbWorks5C::IDX_T => dbWorks5C::FLD_TUE_T ,dbWorks5C::IDX_M => dbWorks5C::FLD_TUE_M) ,			3 => array(dbWorks5C::IDX_F => dbWorks5C::FLD_WED_F ,dbWorks5C::IDX_T => dbWorks5C::FLD_WED_T ,dbWorks5C::IDX_M => dbWorks5C::FLD_WED_M) ,			4 => array(dbWorks5C::IDX_F => dbWorks5C::FLD_THU_F ,dbWorks5C::IDX_T => dbWorks5C::FLD_THU_T ,dbWorks5C::IDX_M => dbWorks5C::FLD_THU_M) ,			5 => array(dbWorks5C::IDX_F => dbWorks5C::FLD_FRI_F ,dbWorks5C::IDX_T => dbWorks5C::FLD_FRI_T ,dbWorks5C::IDX_M => dbWorks5C::FLD_FRI_M) ,			6 => array(dbWorks5C::IDX_F => dbWorks5C::FLD_SAT_F ,dbWorks5C::IDX_T => dbWorks5C::FLD_SAT_T ,dbWorks5C::IDX_M => dbWorks5C::FLD_SAT_M)		);		/***** 変更分の時刻のフィールド *****/		$diffIdxList = array(			0 => array(dbWorks5C::IDX_DIFF_D => dbWorks5C::FLD_DIFF1_D ,dbWorks5C::IDX_DIFF_F => dbWorks5C::FLD_DIFF1_F ,dbWorks5C::IDX_DIFF_T => dbWorks5C::FLD_DIFF1_T ,dbWorks5C::IDX_DIFF_M => dbWorks5C::FLD_DIFF1_M) ,			1 => array(dbWorks5C::IDX_DIFF_D => dbWorks5C::FLD_DIFF2_D ,dbWorks5C::IDX_DIFF_F => dbWorks5C::FLD_DIFF2_F ,dbWorks5C::IDX_DIFF_T => dbWorks5C::FLD_DIFF2_T ,dbWorks5C::IDX_DIFF_M => dbWorks5C::FLD_DIFF2_M) ,			2 => array(dbWorks5C::IDX_DIFF_D => dbWorks5C::FLD_DIFF3_D ,dbWorks5C::IDX_DIFF_F => dbWorks5C::FLD_DIFF3_F ,dbWorks5C::IDX_DIFF_T => dbWorks5C::FLD_DIFF3_T ,dbWorks5C::IDX_DIFF_M => dbWorks5C::FLD_DIFF3_M) ,			3 => array(dbWorks5C::IDX_DIFF_D => dbWorks5C::FLD_DIFF4_D ,dbWorks5C::IDX_DIFF_F => dbWorks5C::FLD_DIFF4_F ,dbWorks5C::IDX_DIFF_T => dbWorks5C::FLD_DIFF4_T ,dbWorks5C::IDX_DIFF_M => dbWorks5C::FLD_DIFF4_M) ,			4 => array(dbWorks5C::IDX_DIFF_D => dbWorks5C::FLD_DIFF5_D ,dbWorks5C::IDX_DIFF_F => dbWorks5C::FLD_DIFF5_F ,dbWorks5C::IDX_DIFF_T => dbWorks5C::FLD_DIFF5_T ,dbWorks5C::IDX_DIFF_M => dbWorks5C::FLD_DIFF5_M) ,			5 => array(dbWorks5C::IDX_DIFF_D => dbWorks5C::FLD_DIFF6_D ,dbWorks5C::IDX_DIFF_F => dbWorks5C::FLD_DIFF6_F ,dbWorks5C::IDX_DIFF_T => dbWorks5C::FLD_DIFF6_T ,dbWorks5C::IDX_DIFF_M => dbWorks5C::FLD_DIFF6_M) ,			6 => array(dbWorks5C::IDX_DIFF_D => dbWorks5C::FLD_DIFF7_D ,dbWorks5C::IDX_DIFF_F => dbWorks5C::FLD_DIFF7_F ,dbWorks5C::IDX_DIFF_T => dbWorks5C::FLD_DIFF7_T ,dbWorks5C::IDX_DIFF_M => dbWorks5C::FLD_DIFF7_M)		);		$work = new dbWorks5C($branchNo);		$workVals = $work->readForWeek($profDir);		$dowList  = $daysList['dowCD'  ];		$daysSTRC = $daysList['daySTRC'];		$daysSTRD = $daysList['daySTRD'];		$prof1 = $workVals['workInfo'][0];		$workTime['DIR' ] = $prof1[dbWorks5C::FLD_DIR];		$workTime['NAME'] = $prof1[dbProfile5C::FLD_NAME];		/*** 各曜日ごとの出勤状態 ***/		for($dayIdx=0 ;$dayIdx<=6 ;$dayIdx++) {			$dowCD1 = $dowList[$dayIdx];			/* フィールド名の取り出し */			$fromIdx = $dowIdxList[$dowCD1][dbWorks5C::IDX_F];			$toIdx   = $dowIdxList[$dowCD1][dbWorks5C::IDX_T];			$workTime[$dayIdx]['DATE'] = $daysSTRD[$dayIdx];			$workTime[$dayIdx]['FROM'] = $prof1[$fromIdx];			$workTime[$dayIdx]['TO'  ] = $prof1[$toIdx  ];		}		/*** 変更分の取り出し ***/		for($dayIdx=0 ;$dayIdx<=6 ;$dayIdx++) {			$dateStr1 = $daysSTRC[$dayIdx];	/* 対象日付 */			for($diffIdx=0 ;$diffIdx<=6 ;$diffIdx++) {				$diffIdx1 = $diffIdxList[$diffIdx];				/*** 対象日付と変更分の日付が一致し、内容があればその内容で上書き ***/				$dateIdx = $diffIdx1[dbWorks5C::IDX_DIFF_D];							/* print $prof1[$dateIdx] . ' ' . $dateStr1 . '**'; */				if(strcmp($prof1[$dateIdx] ,$dateStr1) == 0) {					/* フィールド名の取り出し */					$fromIdx = $diffIdx1[dbWorks5C::IDX_DIFF_F];					$toIdx   = $diffIdx1[dbWorks5C::IDX_DIFF_T];					if(strcmp($prof1[$fromIdx] ,'休') == 0					|| strcmp($prof1[$toIdx  ] ,'休') == 0) {						$workTime[$dayIdx]['FROM'] = $prof1[$fromIdx];						$workTime[$dayIdx]['TO'  ] = $prof1[$toIdx  ];					} else {						if(strlen($prof1[$fromIdx]) >= 1						&& strlen($prof1[$toIdx  ]) >= 1) {							$workTime[$dayIdx]['FROM'] = $prof1[$fromIdx];							$workTime[$dayIdx]['TO'  ] = $prof1[$toIdx  ];						}					}					break;				}			}			if(strcmp($workTime[$dayIdx]['FROM'] ,'休') == 0			|| strcmp($workTime[$dayIdx]['TO'  ] ,'休') == 0) {				$workTime[$dayIdx]['FROM'] = '休';				$workTime[$dayIdx]['TO'  ] = '休';			}		}		return $workTime;	}	function setList($workTime ,$dowTdStr ,$dayStr ,$dowStr) {		$validDays = 0;		for($dayIdx=0 ;$dayIdx<=6 ;$dayIdx++) {			$from = $workTime[$dayIdx]['FROM'];			$to   = $workTime[$dayIdx]['TO'  ];			if(strlen($from) >= 1) {				$timeTdStr = 'workDay';				if(strcmp($from ,'休') == 0) {						/* $timeStr = $from; */	/* '<br>休<br>' */					$timeTdStr = 'nowork';					/* $timeStr   = '&nbsp;<br>&nbsp;<br>&nbsp;'; */					$timeStr   = '&nbsp;';				} else {					/* $timeStr = $from . '<span class="fromTo">～</span>' . $to; */					$timeStr = $from . '～' . $to;					$validDays++;				}			} else {				$timeTdStr = 'nowork';				/* $timeStr   = '&nbsp;<br>&nbsp;<br>&nbsp;'; */				$timeStr   = '&nbsp;';			}			$workStr[$dayIdx  ] = $timeStr;			$workClass[$dayIdx] = $timeTdStr;			$daysStr[$dayIdx  ] = $dayStr[$dayIdx] . '<span class="dow">(' . $dowStr[$dayIdx] . ')</span>';			$daysClass[$dayIdx] = $dowTdStr[$dayIdx];		}		$ret['workStr'  ] = $workStr;		$ret['workClass'] = $workClass;		$ret['daysStr'  ] = $daysStr;		$ret['daysClass'] = $daysClass;		$ret['validDays'] = $validDays;		return $ret;	}?>